<!DOCTYPE html>
<html lang="en">
<head>
<title>Student Enrollment Form</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet"
href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

</head>
<body onload="resetForm();">

<div class="container">
<h2>Student Enrollment Form</h2>

<form id="studForm">

<div class="form-group">
    <label>Roll No:</label>
    <input type="text" class="form-control" id="rollNo" onblur="checkRollNo();" required>
</div>

<div class="form-group">
    <label>Full Name:</label>
    <input type="text" class="form-control" id="fullName">
</div>

<div class="form-group">
    <label>Class:</label>
    <input type="text" class="form-control" id="class">
</div>

<div class="form-group">
    <label>Birth Date:</label>
    <input type="date" class="form-control" id="birthDate">
</div>

<div class="form-group">
    <label>Address:</label>
    <input type="text" class="form-control" id="address">
</div>

<div class="form-group">
    <label>Enrollment Date:</label>
    <input type="date" class="form-control" id="enrollDate">
</div>

<button type="button" class="btn btn-success" id="saveBtn" onclick="saveData();">Save</button>
<button type="button" class="btn btn-warning" id="updateBtn" onclick="updateData();">Update</button>
<button type="button" class="btn btn-default" id="resetBtn" onclick="resetForm();">Reset</button>

</form>
</div>

<script>



const connToken = "90934883|-31949258588666433|90959659";
const dbName = "SCHOOL-DB";
const relName = "STUDENT-TABLE";



function disableAll() {
    $("#fullName,#class,#birthDate,#address,#enrollDate").prop("disabled", true);
}

function enableAll() {
    $("#fullName,#class,#birthDate,#address,#enrollDate").prop("disabled", false);
}

function resetForm() {
    $("#studForm")[0].reset();
    disableAll();
    $("#saveBtn,#updateBtn").prop("disabled", true);
    $("#rollNo").prop("disabled", false);
    $("#rollNo").focus();
}




function validate() {
    let fields = ["rollNo","fullName","class","birthDate","address","enrollDate"];
    for (let f of fields) {
        if ($("#" + f).val().trim() === "") {
            alert("Please fill " + f);
            $("#" + f).focus();
            return false;
        }
    }
    return true;
}




function createGETRequest(token, db, rel, keyValue) {
    return JSON.stringify({
        token: token,
        dbName: db,
        cmd: "GET_BY_KEY",
        rel: rel,
        jsonStr: JSON.stringify({ "Roll-No": keyValue })
    });
}

function createPUTRequest(token, jsonObj, db, rel) {
    return JSON.stringify({
        token: token,
        dbName: db,
        cmd: "PUT",
        rel: rel,
        jsonStr: jsonObj
    });
}

function createUpdateRequest(token, jsonObj, db, rel, recNo) {
    return JSON.stringify({
        token: token,
        dbName: db,
        cmd: "UPDATE",
        rel: rel,
        recordNo: recNo,
        jsonStr: jsonObj
    });
}

function execute(req, endpoint) {
    let res;
    $.ajax({
        url: "http://api.login2explore.com:5577/api/" + endpoint,
        type: "POST",
        async: false,
        data: req,
        success: function(r){ res = r; },
        error: function(r){ res = r.responseJSON; }
    });
    return res;
}



//
function checkRollNo() {
    let rn = $("#rollNo").val().trim();
    if (rn === "") return;

    let req = createGETRequest(connToken, dbName, relName, rn);
    let res = execute(req, "irl");

    if (res.status === 400 || !res.data) {
        // New 
        enableAll();
        $("#saveBtn").prop("disabled", false);
        $("#fullName").focus();
    } else {
        // Existing
        let parsed = JSON.parse(res.data);
        let record = parsed.record;
        let recNo = parsed.rec_no;

        $("#fullName").val(record["Full-Name"]);
        $("#class").val(record["Class"]);
        $("#birthDate").val(record["Birth-Date"]);
        $("#address").val(record["Address"]);
        $("#enrollDate").val(record["Enrollment-Date"]);

        enableAll();
        $("#rollNo").prop("disabled", true);
        $("#updateBtn").prop("disabled", false);

        $("#rollNo").data("recno", recNo);
    }
}

function saveData() {
    if (!validate()) return;

    let json = JSON.stringify({
        "Roll-No": $("#rollNo").val(),
        "Full-Name": $("#fullName").val(),
        "Class": $("#class").val(),
        "Birth-Date": $("#birthDate").val(),
        "Address": $("#address").val(),
        "Enrollment-Date": $("#enrollDate").val()
    });

    let req = createPUTRequest(connToken, json, dbName, relName);
    execute(req, "iml");

    alert("Record Saved!");
    resetForm();
}

function updateData() {
    if (!validate()) return;

    let recNo = $("#rollNo").data("recno");

    let json = JSON.stringify({
        "Full-Name": $("#fullName").val(),
        "Class": $("#class").val(),
        "Birth-Date": $("#birthDate").val(),
        "Address": $("#address").val(),
        "Enrollment-Date": $("#enrollDate").val()
    });

    let req = createUpdateRequest(connToken, json, dbName, relName, recNo);
    execute(req, "iml");

    alert("Record Updated!");
    resetForm();
}

</script>
</body>
</html>
